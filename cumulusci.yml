minimum_cumulusci_version: "2.5.9"
project:
    name: pmdm
    package:
        name: Program Management Data Model
        namespace: pmdm
        api_version: "46.0"
    source_format: sfdx
    git:
        repo_url: https://github.com/SalesforceFoundation/PMDM
        prefix_beta: uat/
        prefix_release: release/
    dependencies:
        - github: https://github.com/SalesforceFoundation/sfdo-base
orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            days: 7
            namespaced: True
        prerelease:
            config_file: orgs/prerelease.json
            days: 7
        npsp:
            config_file: orgs/npsp.json
            days: 7
        npsp_namespaced:
            config_file: orgs/npsp.json
            days: 7
            namespaced: True
        caseman:
            config_file: orgs/caseman.json
            days: 7
        caseman_namespaced:
            config_file: orgs/caseman.json
            days: 7
            namespaced: True
        caseman_npsp:
            config_file: orgs/caseman_npsp.json
            days: 7
        caseman_npsp_namespaced:
            config_file: orgs/caseman_npsp.json
            days: 7
            namespaced: True
        beta_caseman:
            config_file: orgs/beta_caseman.json
            days: 7
        beta_caseman_npsp:
            config_file: orgs/beta_caseman_npsp.json
            days: 7
        beta_npsp:
            config_file: orgs/beta.npsp.json
            days: 7

bulk_data:
    pmdm:
        map: storytelling_data/pmdm/pmdm.yml
        sql: storytelling_data/pmdm/pmdm.sql
        namespace: pmdm

tasks:
    robot:
        options:
            suites: robot/pmdm/tests
            options:
                outputdir: robot/pmdm/results

    robot_testdoc:
        options:
            path: robot/pmdm/tests
            output: robot/pmdm/doc/pmdm_tests.html

    robot_libdoc:
        options:
            path: robot/pmdm/resources/pmdm.py,robot/pmdm/resources/pmdm.robot,robot/pmdm/resources/*PageObject.py
            output: robot/pmdm/doc/Keywords.html

    update_admin_profile:
        options:
            package_xml: lib/admin_profile.xml

    update_admin_profile_caseman:
        class_path: cumulusci.tasks.salesforce.UpdateAdminProfile
        options:
            package_xml: lib/caseman.profile.xml
            record_types:
                - record_type: Account.caseman__Branch
                  default: True
                - record_type: Case.caseman__ClientCase
                  default: True
                - record_type: Case.caseman__Incident
                - record_type: Case.None

    update_admin_profile_npsp:
        class_path: cumulusci.tasks.salesforce.UpdateAdminProfile
        options:
            package_xml: lib/npsp_admin_profile.xml
            record_types:
                - record_type: Account.HH_Account
                - record_type: Account.Organization
                  default: true
                  person_account_default: true
                - record_type: Opportunity.Donation
                  default: true
                - record_type: Campaign.Default
                  default: true

    update_admin_profile_caseman_npsp:
        class_path: cumulusci.tasks.salesforce.UpdateAdminProfile
        options:
            package_xml: lib/caseman.npsp.profile.xml
            record_types:
                - record_type: Account.HH_Account
                - record_type: Account.Organization
                  default: true
                - record_type: Account.caseman__Branch
                  person_account_default: true
                - record_type: Opportunity.Donation
                  default: true
                - record_type: Campaign.Default
                  default: true
                - record_type: Case.caseman__ClientCase
                  default: True
                - record_type: Case.caseman__Incident
                - record_type: Case.None

    run_all_local_tests:
        group: "Tests"
        description: "Runs all local Apex Tests including code coverage"
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: "force:apex:test:run --codecoverage --testlevel RunLocalTests --resultformat human"

    run_tests:
        options:
            retry_failures:
                - "unable to obtain exclusive access to this record"
                - "UNABLE_TO_LOCK_ROW"
            retry_always: True

    dx:
        group: "Salesforce DX"
        description: "Calls a sfdx task with the cci Org User specificed.  Enter the sfdx task with the command option"
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask

    dx_status:
        group: "Salesforce DX"
        description: "Calls sfdx force:source:status for cci Org User"
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: "force:source:status"

    add_caseman_dependency:
        group: Impact Engineering
        description: Installs CaseMan with dependencies
        class_path: cumulusci.tasks.salesforce.UpdateDependencies
        options:
            dependencies:
                - github: "https://github.com/SalesforceFoundation/caseman"
            include_beta: True

    deploy_dev_config:
        group: "pmdm: Config"
        description: Deploys the post-install configuration for an unmanaged DE org
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/config/dev
            namespace_inject: $project_config.project__package__namespace

    log_bulk_data_mapping:
        group: "Data: Bulk"
        description: "Generates a combined mapping configuration for cumulusci.tasks.bulkdata"
        class_path: tasks.BulkData.LogMapping
        options:
            package_mapping_directories:
                - data/bulk/mapping/caseman
                - data/bulk/mapping/npsp
                - data/bulk/mapping/pmdm
            pre_mapping_configs:
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            post_mapping_configs:
                - path: data/bulk/mapping/unpackaged/caseman.yml
                  when_all_namespaces:
                      - caseman
            log_mapping: table

    capture_bulk_data:
        group: "Data: Bulk"
        description: "Captures a snapshot of org's bulk data to sql_path.  Only uses in an org with all possible packages installed."
        class_path: tasks.BulkData.CaptureData
        options:
            sql_path: data/bulk/data.sql
            ignore_row_errors: True
            package_mapping_directories:
                - data/bulk/mapping/caseman
                - data/bulk/mapping/npsp
                - data/bulk/mapping/pmdm
            pre_mapping_configs:
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            post_mapping_configs:
                - path: data/bulk/mapping/unpackaged/caseman.yml
                  when_all_namespaces:
                      - caseman
            log_mapping: table

    insert_bulk_data:
        group: "Data: Bulk"
        description: "Inserts bulk data at sql_path into org with auto-generated mapping"
        class_path: tasks.BulkData.InsertData
        options:
            sql_path: data/bulk/data.sql
            ignore_row_errors: True
            package_mapping_directories:
                - data/bulk/mapping/caseman
                - data/bulk/mapping/npsp
                - data/bulk/mapping/pmdm
            pre_mapping_configs:
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            post_mapping_configs:
                - path: data/bulk/mapping/unpackaged/caseman.yml
                  when_all_namespaces:
                      - caseman

    update_client_photo_directories:
        group: "CaseMan: Test Data"
        description: "Update client photo directories after capture_test_data"
        class_path: "tasks.UpdateClientPhotoDirectories.UpdateClientPhotoDirectories"
        options:
            directory_path: "data/bulk/client-photos"
            sql_path: "data/bulk/data.sql"

    upload_client_photos:
        group: "Data: Bulk: CaseMan"
        description: "Upload client photos and link to client records"
        class_path: "tasks.UploadClientPhotos.UploadClientPhotos"
        options:
            directory_path: "data/bulk/client-photos"

    uninstall_packaged_incremental:
        description: Deletes any metadata from the package in the target org not in the local workspace
        class_path: cumulusci.tasks.salesforce.UninstallPackagedIncremental
        options:
            ignore:
                QuickAction:
                    - NewEvent
                    - NewCase
                    - NewLead
                    - NewContact
                    - NewOpportunity
                    - NewTask
                    - LogACall

    deploy_service_delivery_modal_test:
        group: "pmdm: tests"
        description: Deploys a testModal component to test serviceDeliveryModal component
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/tests/serviceDeliveryModal
            namespace_inject: $project_config.project__package__namespace

    cache_namespaces:
        group: "Org info"
        description: Caches namespaces in org_config if first call to CacheNamespacesTask.
        class_path: tasks.org_info.CacheNamespacesTask

    refresh_namespaces_cache:
        group: "Org info"
        description: Forces refresh of cached namespaces in org_config with API callout.
        class_path: tasks.org_info.RefreshNamespacesCacheTask

    cache_bulk_data_config:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.CacheBulkDataConfigTask
        options:
            bulk_data_log_level: summary

    view_cached_bulk_data_config:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.ViewCachedBulkDataConfigTask
        options:
            bulk_data_log_level: summary

    log_bulk_data_combined_map:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.LogBulkDataCombinedMapTask

    log_bulk_data_step_map:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.LogBulkDataStepMapTask
        options:
            bulk_data_step: pmdm

    log_bulk_data_combined_sql_scripts:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.LogBulkDataCombinedSqlScriptsTask

    log_bulk_data_step_sql_scripts:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.LogBulkDataStepSqlScriptsTask
        options:
            bulk_data_step: pmdm

    delete_bulk_data_step:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.DeleteBulkDataStepTask
        options:
            bulk_data_step: pmdm

    delete_bulk_data_combined:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.DeleteBulkDataCombinedTask

    capture_bulk_data_step:
        group: "Data: Bulk"
        class_path: tasks.sharedbulkdata.CaptureBulkDataStepTask
        options:
            bulk_data_step: pmdm

    insert_bulk_data_step:
        group: "Data: Bulk"
        description: "Inserts bulk data at for bulk_data_step"
        class_path: tasks.sharedbulkdata.InsertBulkDataStepTask
        options:
            bulk_data_step: pmdm

    insert_bulk_data_combined:
        group: "Data: Bulk"
        description: "Inserts combined bulk data"
        class_path: tasks.sharedbulkdata.InsertBulkDataCombinedTask
        options:
            bulk_data_log_level: summary

    update_all_records_as_recently_viewed:
        group: "Data: Script"
        description: Updates Accounts, Contacts, Cases, Opportunities, and all records for Custom Objects having a Tab as recently viewed.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: "data/scripts/update_all_records_as_recently_viewed.apex"

flows:
    cache_bulk_data_config:
        steps:
            10:
                task: caseman:cache_bulk_data_config
            99:
                task: cache_bulk_data_config
                options:
                    bulk_data_log_level: summary

    view_cached_bulk_data_config:
        steps:
            10:
                flow: cache_bulk_data_config
            99:
                task: view_cached_bulk_data_config

    log_bulk_data_combined_map:
        steps:
            01:
                flow: cache_bulk_data_config
            10:
                task: log_bulk_data_combined_map
                options:
                    bulk_data_log_level: all

    log_bulk_data_combined_sql_scripts:
        steps:
            01:
                flow: cache_bulk_data_config
            10:
                task: log_bulk_data_combined_sql_scripts
                options:
                    bulk_data_log_level: all

    delete_bulk_data_combined:
        steps:
            01:
                flow: cache_bulk_data_config
            10:
                task: delete_bulk_data_combined

    assign_permission_sets_to_admin:
        steps:
            1:
                task: cache_namespaces
            10:
                task: dx
                options:
                    command: "force:user:permset:assign --permsetname pmdm__PMDM_View"
                when: '"pmdm" in org_config.namespaces_needing_injection'
            11:
                task: dx
                options:
                    command: "force:user:permset:assign --permsetname pmdm__PMDM_Manage"
                when: '"pmdm" in org_config.namespaces_needing_injection'
            12:
                task: dx
                options:
                    command: "force:user:permset:assign --permsetname pmdm__PMDM_Deliver"
                when: '"pmdm" in org_config.namespaces_needing_injection'
            20:
                task: dx
                options:
                    command: "force:user:permset:assign --permsetname PMDM_View"
                when: '"pmdm" in org_config.namespaces_without_injection'
            21:
                task: dx
                options:
                    command: "force:user:permset:assign --permsetname PMDM_Manage"
                when: '"pmdm" in org_config.namespaces_without_injection'
            22:
                task: dx
                options:
                    command: "force:user:permset:assign --permsetname PMDM_Deliver"
                when: '"pmdm" in org_config.namespaces_without_injection'

    update_admin_profile:
        steps:
            01:
                task: cache_namespaces
            10:
                task: update_admin_profile
                when: '"caseman" not in org_config.namespaces and "npsp" not in org_config.namespaces'
            20:
                task: update_admin_profile_caseman
                when: "'caseman' in org_config.namespaces and 'npsp' not in org_config.namespaces"
            30:
                task: update_admin_profile_npsp
                when: "'caseman' not in org_config.namespaces and 'npsp' in org_config.namespaces"
            40:
                task: update_admin_profile_caseman_npsp
                when: "'caseman' in org_config.namespaces and 'npsp' in org_config.namespaces"

    before_insert_storytelling_data:
        steps:
            10:
                flow: assign_permission_sets_to_admin

    insert_storytelling_data:
        steps:
            1:
                task: cache_namespaces
            10:
                flow: caseman:before_insert_storytelling_data
            11:
                flow: before_insert_storytelling_data
            20:
                flow: cache_bulk_data_config
            21:
                task: insert_bulk_data_combined
            31:
                flow: caseman:after_insert_storytelling_data
            999:
                task: update_all_records_as_recently_viewed

    caseman_org:
        steps:
            100:
                task: add_caseman_dependency
            200:
                flow: dev_org

    caseman_org_namespaced:
        steps:
            100:
                task: add_caseman_dependency
            200:
                flow: dev_org_namespaced

    install_beta_with_caseman:
        steps:
            100:
                task: add_caseman_dependency
            200:
                flow: install_beta

    config_unmanaged:
        steps:
            101:
                flow: update_admin_profile
            200:
                flow: insert_storytelling_data

    config_unmanaged_namespaced:
        steps:
            100:
                flow: update_admin_profile
            200:
                flow: insert_storytelling_data

    config_managed:
        steps:
            100:
                flow: update_admin_profile
            102:
                task: activate_flows
            200:
                flow: insert_storytelling_data

    config_qa:
        steps:
            200:
                flow: config_unmanaged

    config_dev:
        steps:
            200:
                flow: config_unmanaged

    config_dev_namespaced:
        steps:
            100:
                task: deploy_post
            200:
                flow: config_unmanaged_namespaced

    dev_org_namespaced:
        steps:
            1:
                flow: dependencies
            2:
                flow: deploy_unmanaged
            3:
                flow: config_dev_namespaced
            4:
                task: snapshot_changes
